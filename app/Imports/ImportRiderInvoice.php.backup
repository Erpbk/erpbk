<?php

namespace App\Imports;

use App\Helpers\Account;
use App\Helpers\Common;
use App\Helpers\General;
use App\Helpers\HeadAccount;
use App\Models\Items;
use App\Models\RiderInvoiceItem;
use App\Models\RiderInvoices;
use App\Models\Riders;
use App\Models\Vouchers;
use App\Services\TransactionService;
use Illuminate\Database\QueryException;
use Illuminate\Support\Collection;
use Illuminate\Validation\ValidationException;
use Maatwebsite\Excel\Concerns\ToCollection;
use Maatwebsite\Excel\Concerns\ToModel;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Log;
use PhpOffice\PhpSpreadsheet\Shared\Date;
use Carbon\Carbon;

class ImportRiderInvoice implements ToCollection
{
  /**
   * @param array $row
   *
   * @return \Illuminate\Database\Eloquent\Model|null
   */
  public function collection(Collection $rows)
  {
    // Debug: Log first few rows to understand Excel structure
    \Log::info("Excel Import - First 3 rows structure:", [
      'row_0' => $rows[0] ?? null,
      'row_1' => $rows[1] ?? null, 
      'row_2' => $rows[2] ?? null,
      'total_rows' => count($rows)
    ]);
    
    $items = [
      $rows[0][3],
      $rows[0][4],
      $rows[0][5],
      $rows[0][6],
      $rows[0][7],
      $rows[0][8],
      $rows[0][9],
      $rows[0][10],
      $rows[0][11],
      $rows[0][12],
      $rows[0][13],
      $rows[0][14],
      $rows[0][15],
      $rows[0][16],
      $rows[0][17],
      $rows[0][18],
      $rows[0][19],
      $rows[0][20]
    ];
    $i = 1;
    $importedInvoiceIds = [];
    foreach ($rows as $row) {
      $i++;
      try {
        DB::beginTransaction();
        
        // Skip header row and empty rows
        if ($row[1] == 'ID' || empty($row[1])) {
          DB::rollback();
          continue;
        }
        
        \Log::info("Processing row $i with Rider ID: " . $row[1]);
        
        $dateTimeObject = Date::excelToDateTimeObject($row[0]);
        $invoice_date = Carbon::instance($dateTimeObject)->format('Y-m-d');
        
        $billing_month = date('Y-m-01', strtotime($row[28]));
        if ($billing_month == '1970-01-01') {
          $Billingdate = Date::excelToDateTimeObject($row[28]);
          $billing_month = Carbon::instance($Billingdate)->format('Y-m-01');
        }
        
        $rider = Riders::where('rider_id', $row[1])->first();
        if (!$rider) {
          throw ValidationException::withMessages(['file' => 'Row(' . $i . ') - Rider ID ' . $row[1] . ' do not match.']);
        }
        $RID = $rider->id;
        $VID = $rider->VID;
        
        // Check if an unpaid invoice already exists for the same rider and billing month
        $existingInvoice = RiderInvoices::where('rider_id', $RID)
                                      ->where('billing_month', $billing_month)
                                      ->where('status', 0) // unpaid status
                                      ->first();
        
        if (isset($row[21])) {
          // Map status from Excel: allow 'unpaid'/'paid' or 0/1
          $excelStatus = strtolower(trim($row[30] ?? ''));
          if ($excelStatus === 'paid' || $excelStatus === '1') {
            $status = '1'; // Paid
          } else {
            $status = 0; // Unpaid (default)
          }

          // Get bank account from Excel (assuming it's in column 32, adjust index as needed)
          $bankAccountId = $row[32] ?? null;
          
          // Debug logging - remove this in production
          \Log::info("Import Debug - Row $i", [
            'rider_id' => $row[1],
            'rider_name' => $rider->name ?? 'N/A',
            'billing_month' => $billing_month,
            'status_from_excel' => $excelStatus,
            'parsed_status' => $status,
            'existing_invoice_id' => $existingInvoice ? $existingInvoice->id : null,
            'existing_invoice_status' => $existingInvoice ? $existingInvoice->status : null,
            'bank_account_id' => $bankAccountId
          ]);
          
          if ($existingInvoice && ($status == '1' || $status == 1)) {
            // Update existing invoice to paid
            $existingInvoice->update(['status' => 1]);
            
            // Calculate total amount for voucher
            $total = RiderInvoiceItem::where('inv_id', $existingInvoice->id)->sum('amount');
            $vat = $existingInvoice->vat ?? 0;
            $totalWithVat = $total + $vat;
            
            // Create voucher entry
            if ($bankAccountId) {
              $this->createPaymentVoucher($existingInvoice, $rider, $bankAccountId, $totalWithVat, $invoice_date, $billing_month);
            }
            
            $importedInvoiceIds[] = $existingInvoice->id;
            \Log::info("Updated existing invoice to paid", ['invoice_id' => $existingInvoice->id]);
            DB::commit();
            continue; // Skip creating new invoice
          } elseif ($existingInvoice) {
            // If existing invoice found but status is not paid, skip this row
            \Log::info("Skipping row - existing unpaid invoice found", ['invoice_id' => $existingInvoice->id]);
            DB::rollback();
            continue;
          } elseif (!$existingInvoice && ($status == '1' || $status == 1)) {
            // No existing unpaid invoice found, but Excel shows paid - skip this row
            \Log::info("Skipping row - no existing invoice but Excel shows paid");
            DB::rollback();
            continue;
          }
          
          // Create new invoice only if no existing unpaid invoice and current is unpaid
          $ret = RiderInvoices::create([
            'inv_date' => $invoice_date,
            'rider_id' => $RID,
            'vendor_id' => $VID,
            'zone' => $row[23],
            'login_hours' => $row[22],
            'working_days' => $row[24],
            'perfect_attendance' => $row[25],
            'rejection' => $row[21],
            'performance' => $row[27],
            'billing_month' => $billing_month,
            'off' => $row[26],
            'descriptions' => $row[29],
            'notes' => $row[31],
            'status' => $status,
          ]);
          
          $j = 3;
          foreach ($items as $item) {
            $itemId = Items::where('name', $item)->value('id');
            if ($itemId) {
              $riderPrice = General::riderItemPrice($RID, $itemId);
              $dta['item_id'] = $itemId;
              $dta['qty'] = $row[$j] ?? 0;
              $dta['rate'] = $riderPrice;
              $dta['amount'] = ($riderPrice) * ($row[$j]);
              $dta['inv_id'] = $ret->id;
              RiderInvoiceItem::create($dta);
            }
            $j++;
          }
              /* $k = 2;
              foreach ($items as $itemm) {
                  $itemIdd = Item::where('item_name', $itemm)->value('id');
                  if($itemIdd) {
                      $vendorPrice=CommonHelper::vendorItemPrice($VID, $itemIdd);
                      $dtaa['item_id'] = $itemIdd;
                      $dtaa['qty'] = $row[$k]??0;
                      $dtaa['rate'] = $vendorPrice;
                      $dtaa['amount'] = ($vendorPrice) * ($row[$k]);
                      $dtaa['inv_id'] = $ret->id;
                      VendorInvoiceItem::create($dtaa);
                  }
                  $k++;
              } */
              //$vendor_amount=VendorInvoiceItem::where('inv_id',$ret->id)->sum('amount');
              //$profit=$vendor_amount-$rider_amount;
              $total = RiderInvoiceItem::where('inv_id', $ret->id)->sum('amount');
              $vat = 0;
              if ($rider->vat == 1) {
                $vat = $total * (Common::getSetting('vat_percentage') / 100);
                $total = $total + $vat;
              }
              RiderInvoices::where('id', $ret->id)->update(['total_amount' => $total, 'vat' => $vat]);
              if ($status === 0) {
                $rider_amount = RiderInvoiceItem::where('inv_id', $ret->id)->sum('amount');
                $trans_code = Account::trans_code();
                $transactionService = new TransactionService();
                if ($rider->vat == 1) {
                  $transactionData = [
                    'account_id' => HeadAccount::TAX_ACCOUNT,
                    'reference_id' => $ret->id,
                    'reference_type' => 'Invoice',
                    'trans_code' => $trans_code,
                    'trans_date' => $invoice_date,
                    'narration' => "Rider Invoice #" . $ret->id . ' - ' . $row[29],
                    'debit' => $vat ?? 0,
                    'billing_month' => date("Y-m-01", strtotime($row[28])),
                  ];
                  $transactionService->recordTransaction($transactionData);
                }
                $transactionData = [
                  'account_id' => $rider->account_id,
                  'reference_id' => $ret->id,
                  'reference_type' => 'Invoice',
                  'trans_code' => $trans_code,
                  'trans_date' => $invoice_date,
                  'narration' => "Rider Invoice #" . $ret->id . ' - ' . $row[29],
                  'debit' => 0,
                  'credit' => $total ?? 0,
                  'billing_month' => date("Y-m-01", strtotime($row[28])),
                ];
                $transactionService->recordTransaction($transactionData);
                $ret->total_amount = $total;
                $ret->subtotal = $rider_amount;
                $ret->vat = $vat;
                $ret->save();
                $importedInvoiceIds[] = $ret->id;
              }
            }
            // creating Vendor Voucher for Bike rent and Sim charges
              /* if ($row[31]) {
                $Vdata['billing_month'] = $data['billing_month'];
                $Vdata['trans_acc_id'] = $data['trans_acc_id'];
                $Vdata['trans_date'] = $data['trans_date'];
                $Vdata['amount'] = $row[31];
                $Vdata['narration'] = "Bike & Sim Charges";
                $Vdata['voucher_type'] = 9;
                $Vdata['payment_from'] = 811; //Account ID
                $Vdata['payment_type'] = 1; //dr/cr
                Account::CreatVoucher($Vdata);
              }
              //creating Fuel Voucher
              if ($row[32]) {
                $Vdata['billing_month'] = $data['billing_month'];
                $Vdata['trans_acc_id'] = $data['trans_acc_id'];
                $Vdata['trans_date'] = $data['trans_date'];
                $Vdata['amount'] = $row[32];
                $Vdata['narration'] = $row[33];
                $Vdata['voucher_type'] = 11;
                $Vdata['payment_from'] = 617; //Account ID
                $Vdata['payment_type'] = 1; //dr/cr
                Account::CreatVoucher($Vdata);
              }
              // creating RTA Voucher
              if ($row[34]) {
                $Vdata['billing_month'] = $data['billing_month'];
                $Vdata['trans_acc_id'] = $data['trans_acc_id'];
                $Vdata['trans_date'] = $data['trans_date'];
                $Vdata['amount'] = $row[34];
                $Vdata['narration'] = $row[35];
                $Vdata['voucher_type'] = 8;
                $Vdata['payment_from'] = 425; //Account ID
                $Vdata['payment_type'] = 1; //dr/cr
                Account::CreatVoucher($Vdata);

              } */
            }
          }
        }
        DB::commit();
      } catch (QueryException $e) {
        DB::rollBack();
        throw $e;
      }
    }
    if (!empty($importedInvoiceIds)) {
      $account = DB::table('accounts')->where('id', 1)->first();
      $totalPayable = RiderInvoices::whereIn('id', $importedInvoiceIds)->sum('total_amount');
      $firstInvoice = RiderInvoices::find($importedInvoiceIds[0]);
      $transactionService = new TransactionService();
      $trans_code = Account::trans_code();
      $salary_account = DB::table('accounts')->where('id', 1103)->first();
      $transactionDataDebit = [
        'account_id' => $salary_account->id,
        'reference_id' => $firstInvoice ? $firstInvoice->id : 0,
        'reference_type' => 'InvoiceBatch',
        'trans_code' => $trans_code,
        'trans_date' => $firstInvoice ? $firstInvoice->inv_date : now(),
        'narration' => 'Rider Invoices Batch Salary Debit',
        'debit' => $totalPayable,
        'credit' => 0,
        'billing_month' => $firstInvoice ? $firstInvoice->billing_month : now()->format('Y-m-01'),
      ];
      $transactionService->recordTransaction($transactionDataDebit);
    }
  }

  /**
   * Create payment voucher when updating existing invoice to paid
   */
  private function createPaymentVoucher($invoice, $rider, $bankAccountId, $amount, $invoiceDate, $billingMonth)
  {
    $transactionService = new TransactionService();
    $trans_code = Account::trans_code();

    // Create voucher record
    $voucherData = [
      'trans_date' => $invoiceDate,
      'trans_code' => $trans_code,
      'billing_month' => $billingMonth,
      'payment_from' => $bankAccountId, // Bank account that's credited
      'payment_type' => 1, // Payment type
      'voucher_type' => 'PAYMENT', // Payment voucher type
      'amount' => $amount,
      'remarks' => 'Payment for Rider Invoice #' . $invoice->id,
      'rider_id' => $rider->id,
      'Created_By' => Auth::user()->id ?? 1,
      'status' => 1
    ];

    $voucher = Vouchers::create($voucherData);

    // Debit rider account
    $transactionDataDebit = [
      'account_id' => $rider->account_id,
      'reference_id' => $invoice->id,
      'reference_type' => 'InvoicePayment',
      'trans_code' => $trans_code,
      'trans_date' => $invoiceDate,
      'narration' => 'Payment for Rider Invoice #' . $invoice->id,
      'debit' => $amount,
      'credit' => 0,
      'billing_month' => $billingMonth,
    ];
    $transactionService->recordTransaction($transactionDataDebit);

    // Credit bank account
    $transactionDataCredit = [
      'account_id' => $bankAccountId,
      'reference_id' => $invoice->id,
      'reference_type' => 'InvoicePayment',
      'trans_code' => $trans_code,
      'trans_date' => $invoiceDate,
      'narration' => 'Payment received for Rider Invoice #' . $invoice->id,
      'debit' => 0,
      'credit' => $amount,
      'billing_month' => $billingMonth,
    ];
    $transactionService->recordTransaction($transactionDataCredit);
  }
}
